#!/bin/bash
#
# See usage() for documentation
#

set -e
DEFROOT=/opt/lsst

usage()
{
	cat <<-EOF;
		Clones a pre-built binary distribution of the LSST Data Management
		Software Stack.
	
		Usage:
		
		        $0 [-h|--help] [update|install] [dest_dir]

		Running with no command line arguments is equivalent to running
		'$0 install'.

		Arguments:
		install		Install the binary distribution of DM stack
		update		Update an existing binary distribution install

		dest_dir	EXPERIMENTAL: Install the stack to <destdir>, rather
		                than the directory it was originally built in. This
		                is an experimental feature and may cause some
		                misbehavior.
EOF
	exit -2;
}

[[ $1 == "--help" || $1 == "-h" ]] && usage

case "$1" in
install|"")
	MODE=install
	ROOT=${2-$DEFROOT}
	mkdir -p "$ROOT" || { echo "Failed to create $ROOT. Have you forgotten to run this script as root?"; exit -1; }
	[[ -w "$ROOT" ]] || { echo "$ROOT is not writable. Have you forgotten to run this script as root?"; exit -1; }
	[[ -e $ROOT && ! -z $(ls -A "$ROOT") ]] && { echo "$ROOT already has some content; did you mean to run '$0 update'?."; exit -1; }
	;;
update)
	MODE=update
	ROOT=${2-$DEFROOT}
	mkdir -p "$ROOT" || { echo "Failed to create $ROOT. Have you forgotten to run this script as root?"; exit -1; }
	[[ -w "$ROOT" ]] || { echo "$ROOT is not writable. Have you forgotten to run this script as root?"; exit -1; }
	;;
*)
	usage
esac

ROOT=$(cd "$ROOT" && pwd)

detectOS()
{
	OS=$(uname)
	MACH=$(uname -m)

	case $OS in
	"Darwin")
		OS=osx
		VER=$(sw_vers -productVersion | cut -d . -f 1-2)
		;;
	"Linux")
		if [ -f /etc/redhat-release ]; then
			OS="rhel_compatible"
			VER=$(cat /etc/redhat-release | sed -r 's/^.[^0-9.]*([0-9]*).*$/\1/')
		else
			echo "Unknown Linux flavor; please install from source."
		fi
	esac
	
	echo $OS-$VER-$MACH
}

checkPrereq()
{
	OS="$1"

	case $OS in
	rhel_compatible-6-*)
		for rpm in rsync gcc-c++ gcc-gfortran flex bison tk-devel \
			   libXt-devel ncurses-devel readline-devel \
			   libuuid-devel zlib-devel bzip2-devel perl make; \
		do
			rpm --quiet -q "$rpm" || { MISSING_RPMS="$MISSING_RPMS $rpm"; }
		done
		if [[ ! -z $MISSING_RPMS ]]; then
			echo "Missing prerequisites: $MISSING_RPMS"
			echo "As root, run:"
			echo "    yum install $MISSING_RPMS"
			exit -1
		fi
		;;
	rhel_compatible-5-*)
		for rpm in which perl make gcc-c++ flex bison libX11-devel tk-devel \
			   readline-devel zlib-devel gcc44-c++ gcc44-gfortran \
			   e2fsprogs-devel bzip2-devel libXt-devel libstdc++44-devel; \
		do
			rpm --quiet -q "$rpm" || { MISSING_RPMS="$MISSING_RPMS $rpm"; }
		done
		if [[ ! -z $MISSING_RPMS ]]; then
			echo "Missing prerequisites: $MISSING_RPMS"
			echo "As root, run: 'yum install $MISSING_RPMS'"
			exit -1
		fi
		;;
	esac
}

OS=$(detectOS)
URL="rsync://moya.dev.lsstcorp.org/dmstack/dmstack-$OS/"

echo "Detected $OS. Hit CTRL-C if I'm wrong."
checkPrereq "$OS"

echo "Downloading to $ROOT"
echo "Downloading using rsync from $URL"
n=0
while read line; do
	n=$((n+1))
	[[ $((n % 1000)) == 0 ]] && { echo -n '#'; }
done < <(rsync --out-format='%n %b/%l' -az "$URL" "$ROOT")
[[ $n -ge 1000 ]] && echo ""
echo "$n files updated."

BUILDROOT=$(sed -n 's/export LSST_HOME=\(.*\)/\1/p' "$ROOT/loadLSST.sh")
if [[ $ROOT != "$BUILDROOT" ]]; then
	echo "=== Binary distribution was built in $BUILDROOT."
	echo "=== You've installed it in $ROOT."
	echo "=== THIS FEATURE IS EXPERIMENTAL. FOR MAXIMUM COMPATIBILITY,"
	echo "=== INSTALL IN '$BUILDROOT'."
	( cd "$ROOT" && grep -Rl --exclude '*.pyc' --exclude '*~' "$BUILDROOT" eups loadLSST.* | xargs sed -i\~ "s|$BUILDROOT|$ROOT|" )
fi

if [[ $MODE == "install" ]]; then
cat <<-EOF;

	Done. The LSST Data Management stack has been installed in:
	
	    $ROOT

	. If using bash, type:

	    source $ROOT/loadLSST.sh

	or, if using csh:

	    source $ROOT/loadLSST.csh

	to load version management with EUPS and begin using it.

	To update the stack in the future, run:
	
	   setup lsst_distrib_tool
	   lsst-distrib update
	   
EOF
fi

echo "Done."
