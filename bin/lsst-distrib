#!/bin/bash
#
# See usage() for documentation
#

set -e
URLBASE=${DISTRIB_URL-"rsync://moya.dev.lsstcorp.org/dmstack"}

usage()
{
	cat <<-EOF;
		Clones a pre-built binary distribution of the LSST Data Management
		Software Stack.
	
		Usage:
		
		        $CMD [-h|--help] [update|install] [dest_dir]
		        
		Examples:
		
		        $CMD install
		        $CMD update
		        $CMD install mystack

		Arguments:

		install		Install the binary distribution of DM stack
		update		Update an existing binary distribution install

		dest_dir	EXPERIMENTAL: Install the stack to <destdir>, rather
		                than the directory it was originally built in. This
		                is an experimental feature and may cause some
		                misbehavior.

		Environment variables:
		
		CHECK_PREREQ	If set to 0, won't check for prerequisites.
		DISTRIB_URL	If set, override the default remote location from
		                which the binaries will be downloaded

EOF
	exit -2;
}

detectOS()
{
	OS=$(uname)
	MACH=$(uname -m)

	case $OS in
	"Darwin")
		OS=osx
		VER=$(sw_vers -productVersion | cut -d . -f 1-2)
		;;
	"Linux")
		if [ -f /etc/redhat-release ]; then
			OS="rhel"
			VER=$(cat /etc/redhat-release | sed -r 's/^.[^0-9.]*([0-9]*).*$/\1/')
		else
			echo "Unknown Linux flavor; please install from source."
			exit -1
		fi
		;;
	*)
		echo "Unsupported operating system. Try installing from source"
		exit -1
		;;
	esac
	
	echo $OS-$VER-$MACH
}

checkPrereq()
{
	OS="$1"
	MACH=$(echo "$OS" | cut -d- -f 3)

	[[ $CHECK_PREREQ == 0 ]] && return 0

	case $OS in
	rhel-6-*)
		for rpm in rsync gcc-c++ gcc-gfortran flex bison tk-devel \
			   libXt-devel ncurses-devel readline-devel \
			   libuuid-devel zlib-devel bzip2-devel perl make; \
		do
			rpm --quiet -q "$rpm.$MACH" || { MISSING_RPMS="$MISSING_RPMS $rpm"; }
		done
		if [[ ! -z $MISSING_RPMS ]]; then
			echo "Missing prerequisites: $MISSING_RPMS"
			echo "As root, run:"
			echo "    yum install $MISSING_RPMS"
			exit -1
		fi
		;;
	rhel-5-*)
		for rpm in which perl make gcc-c++ flex bison libX11-devel tk-devel \
			   readline-devel zlib-devel gcc44-c++ gcc44-gfortran \
			   e2fsprogs-devel bzip2-devel libXt-devel libstdc++44-devel; \
		do
			rpm --quiet -q "$rpm.$MACH" || { MISSING_RPMS="$MISSING_RPMS $rpm"; }
		done
		if [[ ! -z $MISSING_RPMS ]]; then
			echo "Missing prerequisites: $MISSING_RPMS"
			echo "As root, run:"
			echo "    yum install $MISSING_RPMS"
			exit -1
		fi
		;;
	esac
}

getAvailableStacks()
{
	echo $(rsync $1 -n  | grep "^d" | grep -v ".* \.$" | awk '{print $5}')
	##echo "osx-10.7-x86_64 osx-10.8-x86_64 rhel-6-x86_64"
}

containsElement()
{
	local e
	for e in "${@:2}"; do [[ "$e" == "$1" ]] && return 0; done
	return 1
}

###########

CMD=$(basename "$0")
OS=$(detectOS)

[[ $1 == "--help" || $1 == "-h" ]] && usage
containsElement "$1" install update || usage

[[ -z "$LSST_HOME" ]] && unset LSST_HOME
DEFROOT=${LSST_HOME-/opt/lsst/$OS}
ROOT=${2-$DEFROOT}

# Detect OS, ask for confirmation if it's different from what's stored in $ROOT/.os
test -f "$ROOT/.os" && OS_STORED=$(head -n 1 "$ROOT/.os")
if [[ $OS != $OS_STORED ]]; then
	STACKS=( $(getAvailableStacks "$URLBASE") )
	containsElement "$OS" "${STACKS[@]}" && SUPP="supported" || SUPP="UNSUPPORTED"
	while true; do
		echo    "Install version for which platform (destination: $ROOT)?"
		echo    "   Available platforms: ${STACKS[@]}"
		echo    "   Detected platform:   $OS ($SUPP)"
		read -p "Enter platform, press ENTER to use '$OS', or CTRL-C to quit: " os

		[[ -z "$os" ]] && os="$OS"

		if ! containsElement "$os" "${STACKS[@]}"; then
			echo
			echo "No binary distribution is available for platform '$os'."
			echo
		else
			break
		fi
	done
	echo

	OS="$os"
	DEFROOT=${LSST_HOME-/opt/lsst/$OS}
	ROOT=${2-$DEFROOT}

	# If there's a mismatch with what's in $ROOT/.os, ask for confirmation
	if [[ -f "$ROOT/.os" ]]; then
		OS_STORED=$(head -n 1 "$ROOT/.os")
		if [[ $OS != $OS_STORED ]]; then
			while true; do
				echo "You've elected to install the distribution for platform $OS, but the" \
				     "directory to which you're installing contains binaries for $OS_STORED."
				read -p "Are you sure you want to continue (y/n)? " yn
				case $yn in
					[Yy]* ) break;;
					[Nn]* ) echo "Quitting."; exit -1;;
					* ) echo "Please answer yes or no.";;
				esac
			done
		fi
	fi
fi

# Decide on mode of operation
case "$1" in
install)
	MODE=install
	mkdir -p "$ROOT" || { echo "Failed to create $ROOT. Do you have the necessary permissions?"; exit -1; }
	[[ -w "$ROOT" ]] || { echo "$ROOT is not writable. Do you have permissions to write there?"; exit -1; }
	[[ -e $ROOT && ! -z $(ls -A "$ROOT") ]] && { echo "$ROOT already has some content; did you mean to run '$CMD update'?."; exit -1; }
	;;
update)
	MODE=update
	mkdir -p "$ROOT" || { echo "Failed to create $ROOT. Do you have the necessary permissions??"; exit -1; }
	[[ -w "$ROOT" ]] || { echo "$ROOT is not writable. Do you have permissions to write there?"; exit -1; }
	;;
*)
	usage
esac

ROOT=$(cd "$ROOT" && pwd)
echo "Installing to $ROOT"

checkPrereq "$OS"

URL="$URLBASE/$OS/"
echo "Downloading using rsync from $URL"
n=0
while read line; do
	n=$((n+1))
	[[ $((n % 1000)) == 0 ]] && { echo -n '#'; }
done < <(rsync --out-format='%n %b/%l' -az "$URL" "$ROOT")
[[ $n -ge 1000 ]] && echo ""
echo "$n files updated."

BUILDROOT=$(sed -n 's/export LSST_HOME=\(.*\)/\1/p' "$ROOT/loadLSST.sh")
if [[ $ROOT != "$BUILDROOT" ]]; then
	echo "=== Binary distribution was built in $BUILDROOT."
	echo "=== You've installed it in $ROOT."
	echo "=== THIS FEATURE IS EXPERIMENTAL. FOR MAXIMUM COMPATIBILITY,"
	echo "=== INSTALL IN '$BUILDROOT'."
	(
		# The two-step process is to avoid making a replacement in the same file twice
		# (e.g., if the file is accessible through a symlink, and the replacement still
		# matches the pattern). One could do the same by sorting on inode
		cd "$ROOT"
		grep -Rl --exclude '*.pyc' --exclude '*~' "$BUILDROOT" eups loadLSST.* | xargs sed -i\~ "s|$BUILDROOT|__DUMMYPATTERN__|"
		grep -Rl --exclude '*.pyc' --exclude '*~' "__DUMMYPATTERN__" eups loadLSST.* | xargs sed -i\~\~ "s|__DUMMYPATTERN__|$ROOT|"
	)
fi

if [[ $MODE == "install" ]]; then
cat <<-EOF;

	Done. The LSST Data Management stack has been installed in:
	
	    $ROOT

	. If using bash, type:

	    source $ROOT/loadLSST.sh

	or, if using csh:

	    source $ROOT/loadLSST.csh

	to load version management with EUPS and begin using it.

	To update the stack in the future, run:
	
	   setup lsst_distrib_tool
	   lsst-distrib update
	   
EOF
fi

echo "Done."
